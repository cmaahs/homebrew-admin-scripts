#!/usr/bin/env zsh

FETCH_OUTPUT=$(git fetch)
echo ${FETCH_OUTPUT}
git status
git pull

LOCAL_TAGS=$(git show-ref --tags)
REMOTE_TAGS=$(git ls-remote --tags origin | sed 's/\t/ /g')
BAD_TAGS=$(diff -c <(echo "${LOCAL_TAGS}") <(echo "${REMOTE_TAGS}") | grep 'refs' | grep -v '^ ' | grep -v '\^{}$' | cut -d' ' -f3 | sort -u | wc -l | awk '{print $1}')
if [[ "${BAD_TAGS}" != "0" ]]; then
  DO_IT=$(echo "Yes\nNo" | fzf --prompt "Reset TAGs to origin? ")
  if [[ "${DO_IT}" == "Yes" ]]; then
    git tag -d $(git tag)
    git fetch --tags
  fi
fi

DELETED_BRANCHES=($(echo ${FETCH_OUTPUT} | grep '\[deleted\]' | cut -d'/' -f 2-))

for DB in ${DELETED_BRANCHES}; do
  DO_IT=$(echo "Yes\nNo" | fzf --prompt "DELETE 'local' branch ${DB} ?")
  if [[ "${DO_IT}" == "Yes" ]]; then
    git branch -d $(DB)
  fi
done

# From https://github.com/Maahsome/gitlab-go
# - [deleted]         (none)     -> origin/GT-3/add-delete-calls-mock
# - [deleted]         (none)     -> origin/GT-4/add-delete-calls

